<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

    <div id="formWrapper">
        <div id="form">
            <input type="text" placeholder="name" id="name"><br>
            <input type="text" placeholder="email" id="email"><br>
            <input type="text" placeholder="2+2=" id="challenge">
            <p id="result"></p>
            <button id="send">Subscribe</button>
        </div>
    </div>
    <a href="#">Test</a>
    <script>
        document.getElementById("send").onclick = () => {
            sendJSON()
        }


        function sendJSON() {

            let result = document.querySelector('#result');
            let name = document.querySelector('#name');
            let email = document.querySelector('#email');
            let challenge = document.querySelector('#challenge');
            let valid = true;

            function validate() {
                filterArr = [
                    //challenge filter
                    () => {
                        console.log("challenge filter")
                        if (challenge.value == 4 && valid == true) {
                            return true;
                        } else {
                            result.innerHTML = "<span style='color:red'>Challenge is incorrect.</span>"
                            return false;
                        }
                    },
                    //email filter
                    () => {
                        console.log("email filter");

                        var filter = /^\s*[\w\-\+_]+(\.[\w\-\+_]+)*\@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/;

                        let emailValid =  String(email.value).search(filter) != -1;
                        if(!emailValid){
                            result.innerHTML = "<span style='color:red'>Email invalid.</span>";
                            return false;
                        }
                        return true;
                    }
                ];
                //if any filters fail, return false
                filterArr.forEach((filter) => {
                    console.log(filter)
                    if (!filter()) {
                        console.log("false")
                        valid = false;
                        return false;
                    }
                });
                //otherwise all filters are valid, return true.
                return true;
            }

            // Creating a XHR object
            let xhr = new XMLHttpRequest();
            let url = "log.php";

            // open a connection
            xhr.open("POST", url, true);

            // Set the request header i.e. which type of content you are sending
            xhr.setRequestHeader("Content-Type", "application/json");

            // Create a state change callback
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {

                    // Print received data from server
                    result.innerHTML =
                        "Thank you for subscribing!  You'll be the first to know of any new updates.";

                }
            };

            // Converting JSON data to string
            var data = JSON.stringify({
                "name": name.value,
                "email": email.value
            });
            console.log(data)

            validate();
            // Sending data with the request
            if (valid) {
                xhr.send(data);
            }

        }
    </script>
    <style>
        html,
        body {
            background: #CCC;
            width: 100%;
            height: 100%;
        }

        #formWrapper {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #form {
            /* display: none; */
            position: relative;
            margin: 30px;
            padding: 20px;


            border-radius: 10px;
            background-color: #FFF;

        }
    </style>
</body>

</html>